{
  "completed_at": 1763592854,
  "content": "## Goal: Build Essential Refactoring Safety Tool\n\n`fast_refs` answers the critical question: **\"Where is this symbol used?\"**\n\nThis is essential for:\n- Safe refactoring (know impact before changing code)\n- Impact analysis (understand dependencies)\n- Code exploration (find usage examples)\n- Foundation for trace_call_path (refs = breadth, trace = depth)\n\n---\n\n## Success Criteria\n\n**Core Functionality:**\n- \u2705 Find all references to a symbol by name\n- \u2705 Return file paths, line numbers, context snippets\n- \u2705 Support workspace filtering (primary vs reference)\n- \u2705 Filter by reference type (calls, imports, extends, implements)\n- \u2705 Performance: <100ms for typical symbols, <500ms for heavily-used symbols\n\n**Output Quality:**\n- \u2705 Grouped by file (easier to read)\n- \u2705 Sorted by usage frequency (most-used files first)\n- \u2705 Context snippets show actual usage (line of code)\n- \u2705 Includes reference kind (Call, Import, Extends, etc.)\n\n---\n\n## Phase 1: Basic Implementation (Foundation)\n\n### Task 1.1: Database Query Foundation\n**Goal:** Query symbol_relationships table correctly\n\n- [ ] Query relationships table by target symbol name\n- [ ] Filter by relationship_kind (Call, Reference, Import, etc.)\n- [ ] Join with symbols table to get file paths and locations\n- [ ] Return basic data: file_path, line, kind\n\n**Tests:**\n- [ ] Test finding references for known symbol\n- [ ] Test filtering by relationship kind\n- [ ] Test handling symbol with no references\n- [ ] Test handling non-existent symbol\n\n---\n\n### Task 1.2: Context Snippet Extraction\n**Goal:** Show actual code where symbol is used\n\n- [ ] Read source files for reference lines\n- [ ] Extract line of code (with symbol usage)\n- [ ] Add surrounding context (\u00b11-2 lines optional)\n- [ ] Handle file read errors gracefully\n\n**Tests:**\n- [ ] Test context extraction from Python file\n- [ ] Test context extraction from TypeScript file\n- [ ] Test handling deleted/moved files\n- [ ] Test handling binary files\n\n---\n\n### Task 1.3: Workspace Filtering\n**Goal:** Support primary vs reference workspace queries\n\n- [ ] Add workspace parameter (\"primary\" or workspace_id)\n- [ ] Query appropriate workspace database\n- [ ] Handle cross-workspace references\n- [ ] Filter results by workspace if specified\n\n**Tests:**\n- [ ] Test primary workspace filtering\n- [ ] Test reference workspace filtering\n- [ ] Test cross-workspace references\n- [ ] Test invalid workspace handling\n\n---\n\n## Phase 2: Output Quality & UX\n\n### Task 2.1: Grouping & Sorting\n**Goal:** Make output easy to scan and understand\n\n```python\n# Example output structure:\n{\n  \"symbol\": \"calculateAge\",\n  \"total_references\": 47,\n  \"files\": [\n    {\n      \"path\": \"src/user_service.py\",\n      \"references_count\": 23,\n      \"references\": [\n        {\"line\": 45, \"kind\": \"Call\", \"context\": \"age = calculateAge(user.birthdate)\"},\n        {\"line\": 67, \"kind\": \"Call\", \"context\": \"return calculateAge(dob)\"}\n      ]\n    },\n    {\n      \"path\": \"src/profile.py\",\n      \"references_count\": 12,\n      ...\n    }\n  ]\n}\n```\n\n**Implementation:**\n- [ ] Group references by file\n- [ ] Sort files by reference count (most-used first)\n- [ ] Sort references within file by line number\n- [ ] Add total_references count\n\n**Tests:**\n- [ ] Test grouping by file\n- [ ] Test sorting by reference count\n- [ ] Test line number ordering\n- [ ] Test total count accuracy\n\n---\n\n### Task 2.2: Reference Kind Filtering\n**Goal:** Filter by type of reference (calls only, imports only, etc.)\n\n- [ ] Add kind parameter (optional filter)\n- [ ] Support multiple kinds ([\"Call\", \"Import\"])\n- [ ] Map tree-sitter relationship types\n- [ ] Document available kinds per language\n\n**Tests:**\n- [ ] Test filtering by single kind (Call)\n- [ ] Test filtering by multiple kinds (Call, Reference)\n- [ ] Test filtering by Import\n- [ ] Test filtering by Extends/Implements\n\n---\n\n### Task 2.3: Symbol Disambiguation\n**Goal:** Handle symbols with same name in different scopes\n\n- [ ] Add context_file parameter (disambiguate by file)\n- [ ] Add qualified_name support (Class.method)\n- [ ] Handle overloaded functions/methods\n- [ ] Provide disambiguation suggestions if ambiguous\n\n**Tests:**\n- [ ] Test disambiguating User class vs user variable\n- [ ] Test qualified name resolution (UserService.create)\n- [ ] Test handling multiple symbols with same name\n- [ ] Test providing disambiguation suggestions\n\n---\n\n## Phase 3: Performance & Polish\n\n### Task 3.1: Performance Optimization\n**Target:** <100ms typical, <500ms heavily-used symbols\n\n- [ ] Add database indexes on symbol_relationships(target_id)\n- [ ] Batch file reads (don't read same file multiple times)\n- [ ] Cache file contents during query (avoid re-reading)\n- [ ] Limit results with pagination support\n- [ ] Add performance logging\n\n**Tests:**\n- [ ] Benchmark query with 100+ references\n- [ ] Benchmark query with 1000+ references\n- [ ] Test pagination correctness\n- [ ] Test cache effectiveness\n\n---\n\n### Task 3.2: Output Formats\n**Goal:** Support different output formats for different use cases\n\n- [ ] JSON format (default, structured data)\n- [ ] Markdown format (human-readable)\n- [ ] Summary format (just counts, no context)\n- [ ] Tree format (nested by file)\n\n**Tests:**\n- [ ] Test JSON output structure\n- [ ] Test markdown rendering\n- [ ] Test summary format\n- [ ] Test tree format\n\n---\n\n### Task 3.3: Error Handling & Edge Cases\n**Goal:** Graceful degradation and helpful errors\n\n- [ ] Handle symbol not found\n- [ ] Handle symbol with no references\n- [ ] Handle deleted/moved files\n- [ ] Handle unparseable context lines\n- [ ] Handle database query errors\n\n**Tests:**\n- [ ] Test non-existent symbol handling\n- [ ] Test zero references handling\n- [ ] Test missing file handling\n- [ ] Test malformed data handling\n\n---\n\n### Task 3.4: Documentation & Examples\n**Goal:** Make tool easy to use for agents and humans\n\n- [ ] Document all parameters and defaults\n- [ ] Add usage examples for common scenarios\n- [ ] Add troubleshooting guide\n- [ ] Update TOOLS_PLAN.md with implementation details\n\n**Deliverables:**\n- [ ] FAST_REFS_GUIDE.md (similar to GET_SYMBOLS_GUIDE.md)\n- [ ] Usage examples in docstrings\n- [ ] MCP tool description\n- [ ] Performance benchmarks\n\n---\n\n## Implementation Notes\n\n### Key Design Decisions\n\n1. **Group by file for readability**\n   - Easier to understand impact (\"This file uses it 23 times\")\n   - Agents can focus on high-impact files first\n   - Better than flat list of all references\n\n2. **Include context snippets**\n   - Shows actual usage (how symbol is called)\n   - Helps understand different usage patterns\n   - Valuable for refactoring decisions\n\n3. **Workspace awareness**\n   - Support primary + reference workspaces\n   - Show cross-workspace references (library usage)\n   - Essential for monorepos\n\n4. **Graceful degradation**\n   - If file missing, show reference without context\n   - If relationship data incomplete, show what we have\n   - Never fail completely, always return something useful\n\n### Database Schema (Existing)\n\nWe already have the `symbol_relationships` table from indexing:\n```sql\nCREATE TABLE symbol_relationships (\n  id INTEGER PRIMARY KEY,\n  source_id INTEGER NOT NULL,\n  target_id INTEGER NOT NULL,\n  relationship_kind TEXT NOT NULL,\n  location_start_line INTEGER,\n  location_end_line INTEGER,\n  FOREIGN KEY (source_id) REFERENCES symbols(id) ON DELETE CASCADE,\n  FOREIGN KEY (target_id) REFERENCES symbols(id) ON DELETE CASCADE\n);\n```\n\n**Key insight:** We just need to query this table efficiently!\n\n### Performance Considerations\n\n1. **Add index:** `CREATE INDEX idx_relationships_target ON symbol_relationships(target_id)`\n2. **Batch file reads:** If 50 refs in same file, read file once\n3. **Limit results:** Default to top 100 references, support pagination\n4. **Cache:** Cache file contents during single query execution\n\n---\n\n## Test Strategy\n\n### Unit Tests (per task)\n- Test each function in isolation\n- Mock database and file system\n- Cover edge cases\n\n### Integration Tests\n- Test with real indexed workspace\n- Verify relationships table is queried correctly\n- Validate output format\n\n### Performance Tests\n- Benchmark with symbols having 10, 100, 1000+ refs\n- Measure query time, file I/O time\n- Validate caching effectiveness\n\n### Comparison Tests\n- Compare with Julie's find_references (if exists)\n- Validate correctness against manual inspection\n- Ensure we're not missing references\n\n---\n\n## Milestones\n\n- **M1: Basic Query** - Can find references and return file/line (1 day)\n- **M2: Context & Grouping** - Beautiful output with context snippets (1 day)\n- **M3: Performance & Polish** - Fast, robust, documented (1 day)\n\n**Total Estimate:** 2-3 days of focused work\n\n---\n\n## Success Metrics\n\n**Quantitative:**\n- Performance: <100ms for typical symbols\n- Accuracy: 100% of references found (validate against manual inspection)\n- Test coverage: >85% of fast_refs code\n\n**Qualitative:**\n- Agent feedback: \"fast_refs shows me exactly what will break if I change this\"\n- Human feedback: \"Best way to understand symbol usage I've seen\"\n- Refactoring confidence: \"I can safely refactor knowing the impact\"\n\n---\n\n## Next Steps After Completion\n\n1. Checkpoint this milestone\n2. Update TOOLS_PLAN.md with implementation status\n3. Create FAST_REFS_GUIDE.md with usage examples\n4. Move on to trace_call_path (the killer feature!)\n5. Consider: fast_refs could be enhanced with usage pattern analysis later",
  "git": {
    "branch": "main",
    "commit": "af6b268",
    "dirty": true,
    "files_changed": [
      ".memories/plans/plan_complete-getsymbols-better-than-julie.json",
      "python/miller/tools/symbols.py",
      "python/tests/test_get_symbols.py",
      ".memories/2025-11-19/161543_a28d.json",
      ".memories/2025-11-19/162459_53f7.json",
      ".memories/2025-11-19/162914_f397.json",
      "GET_SYMBOLS_GUIDE.md",
      "benchmark_get_symbols.py"
    ]
  },
  "id": "plan_implement-fastrefs-find-all-symbol-references",
  "status": "completed",
  "timestamp": 1763591732,
  "title": "Implement fast_refs - Find All Symbol References",
  "type": "plan"
}
