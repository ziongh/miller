{
  "completed_at": 1763575905,
  "content": "## Goal\nImplement Miller's `manage_workspace` MCP tool with reference workspace support, following strict TDD methodology.\n\n## Architecture Overview\n\n**Workspace Isolation Model** (matches Julie):\n```\n.miller/indexes/\n\u251c\u2500\u2500 miller_primary_abc123/      \u2190 PRIMARY workspace\n\u2502   \u251c\u2500\u2500 symbols.db              \u2190 SQLite database\n\u2502   \u2514\u2500\u2500 vectors.lance           \u2190 LanceDB vectors\n\u2502\n\u2514\u2500\u2500 my-framework_def456/        \u2190 REFERENCE workspace\n    \u251c\u2500\u2500 symbols.db              \u2190 Separate SQLite\n    \u2514\u2500\u2500 vectors.lance           \u2190 Separate LanceDB\n```\n\n**Key Principles:**\n- Physical isolation: Each workspace = separate DB + vectors\n- Primary workspace: Where Miller is running (has `.miller/` directory)\n- Reference workspaces: Other codebases to search (indexed in primary's `.miller/indexes/`)\n- Project-level storage: `.miller/` at project root (NOT `~/.miller/`)\n\n---\n\n## \u2705 Phase 1: Core Foundation (COMPLETE - 4 hours)\n\n**Status**: \u2705 **COMPLETE** - All 23 tests passing, committed and pushed\n\n**What We Built:**\n1. \u2705 WorkspaceRegistry (10 tests, 88% coverage)\n   - Workspace metadata tracking\n   - Persistent JSON storage\n   - Add/get/remove/list operations\n   - Stable workspace ID generation\n\n2. \u2705 Workspace Paths (5 tests, 100% coverage)\n   - Consistent path generation for DB/vectors\n   - Directory creation utilities\n   - Isolated workspace storage\n\n3. \u2705 manage_workspace Tool (8 tests, 88% coverage)\n   - List operation (show all workspaces)\n   - Stats operation (detailed workspace info)\n   - Formatted output with metadata\n\n4. \u2705 MCP Registration\n   - Tool registered in server.py\n   - Available via MCP protocol\n\n**TDD Discipline:**\n- \u2705 All 23 tests written FIRST\n- \u2705 All tests failed initially\n- \u2705 Implementation made them pass\n- \u2705 No code without tests\n\n**Committed**: Commit 9af0947 - \"feat: Implement manage_workspace Phase 1 (list/stats) with TDD\"\n\n---\n\n## Phase 2: Reference Workspaces (6-8 hours) - NEXT\n\n### Goals\n- Implement add/remove operations\n- Support multiple workspace databases\n- Add workspace parameter to search tools\n\n### 2.1 Add Reference Workspace (TDD - 3 hours)\n\n**Tests First:**\n```python\ndef test_add_reference_workspace():\n    \"\"\"Can add reference workspace and index it.\"\"\"\n    result = await manage_workspace(\n        operation=\"add\",\n        path=\"/path/to/other-project\",\n        name=\"Other Project\"\n    )\n    \n    assert \"Successfully added\" in result\n    assert \"Other Project\" in result\n    \n    # Verify it's in registry\n    registry = WorkspaceRegistry()\n    workspaces = registry.list_workspaces()\n    assert len(workspaces) == 2  # primary + reference\n    \ndef test_add_indexes_reference_workspace():\n    \"\"\"Adding reference workspace triggers indexing.\"\"\"\n    result = await manage_workspace(\n        operation=\"add\",\n        path=\"/path/to/real-project\",\n        name=\"Real Project\"\n    )\n    \n    # Should have indexed files\n    registry = WorkspaceRegistry()\n    workspace = [w for w in registry.list_workspaces() if w[\"name\"] == \"Real Project\"][0]\n    assert workspace[\"symbol_count\"] > 0\n    assert workspace[\"file_count\"] > 0\n```\n\n**Implementation:** Extend manage_workspace with add operation\n\n### 2.2 Remove Workspace (TDD - 1 hour)\n\n**Tests First:**\n```python\ndef test_remove_workspace_deletes_files():\n    \"\"\"Remove operation deletes workspace data.\"\"\"\n    # Add workspace\n    workspace_id = add_test_workspace()\n    \n    # Remove it\n    result = await manage_workspace(\n        operation=\"remove\",\n        workspace_id=workspace_id\n    )\n    \n    assert \"Successfully removed\" in result\n    \n    # Verify files deleted\n    db_path = get_workspace_db_path(workspace_id)\n    assert not db_path.exists()\n```\n\n### 2.3 Multi-Workspace Search (TDD - 2 hours)\n\n**Tests First:**\n```python\ndef test_search_filters_by_workspace():\n    \"\"\"fast_search can filter by workspace_id.\"\"\"\n    # Index two workspaces\n    ws1_id = index_workspace(\"/project1\")\n    ws2_id = index_workspace(\"/project2\")\n    \n    # Search specific workspace\n    results = await fast_search(\n        \"function\",\n        workspace_id=ws1_id\n    )\n    \n    # All results should be from ws1\n    assert all(r[\"workspace_id\"] == ws1_id for r in results)\n\ndef test_search_all_workspaces_by_default():\n    \"\"\"fast_search searches all workspaces if no filter.\"\"\"\n    results = await fast_search(\"function\")\n    \n    # Should have results from multiple workspaces\n    workspace_ids = {r[\"workspace_id\"] for r in results}\n    assert len(workspace_ids) > 1\n```\n\n**Implementation:** \n- Add `workspace_id` parameter to fast_search\n- Query correct database based on workspace_id\n- Merge results from multiple workspaces if no filter\n\n---\n\n## Phase 3: Maintenance (4-6 hours)\n\n### 3.1 Refresh Operation (TDD - 2 hours)\n\n**Tests First:**\n```python\ndef test_refresh_reindexes_workspace():\n    \"\"\"Refresh re-indexes workspace with new files.\"\"\"\n    workspace_id = create_test_workspace()\n    \n    # Add new file to workspace\n    add_file_to_workspace(workspace_id, \"new.py\")\n    \n    # Refresh\n    result = await manage_workspace(\n        operation=\"refresh\",\n        workspace_id=workspace_id\n    )\n    \n    # Should show updated counts\n    stats = get_workspace_stats(workspace_id)\n    assert stats[\"file_count\"] increased\n```\n\n### 3.2 Clean Operation (TDD - 2 hours)\n\n**Tests First:**\n```python\ndef test_clean_removes_orphaned_workspaces():\n    \"\"\"Clean removes workspaces with deleted paths.\"\"\"\n    # Create workspace for non-existent path\n    workspace_id = registry.add_workspace(\n        path=\"/does/not/exist\",\n        name=\"Orphaned\"\n    )\n    \n    result = await manage_workspace(operation=\"clean\")\n    \n    assert \"Removed 1 orphaned workspace\" in result\n    assert registry.get_workspace(workspace_id) is None\n```\n\n### 3.3 Health Check (TDD - 1 hour)\n\n**Tests First:**\n```python\ndef test_health_shows_system_status():\n    \"\"\"Health check shows registry, DB, vector status.\"\"\"\n    result = await manage_workspace(\n        operation=\"health\",\n        detailed=True\n    )\n    \n    assert \"Registry:\" in result\n    assert \"Databases:\" in result\n    assert \"Vector indexes:\" in result\n```\n\n---\n\n## Success Criteria\n\n**Phase 1 Complete When:**\n- \u2705 WorkspaceRegistry tests passing (10/10 tests)\n- \u2705 Workspace paths tests passing (5/5 tests)\n- \u2705 manage_workspace list/stats working (8/8 tests)\n- \u2705 Can list workspaces via MCP tool\n- \u2705 Committed and pushed (9af0947)\n\n**Phase 2 Complete When:**\n- \u23f3 Can add reference workspace\n- \u23f3 Reference workspace auto-indexes\n- \u23f3 Can remove workspace (deletes files)\n- \u23f3 fast_search has workspace_id filter\n- \u23f3 Can search across multiple workspaces\n\n**Phase 3 Complete When:**\n- \u23f3 Refresh re-indexes workspace\n- \u23f3 Clean removes orphaned data\n- \u23f3 Health check shows system status\n- \u23f3 All operations tested and documented\n\n---\n\n## TDD Discipline Checklist\n\nFor EVERY feature:\n1. \u2705 Write failing test FIRST\n2. \u2705 Run test, verify it fails\n3. \u2705 Write minimal code to pass\n4. \u2705 Run test, verify it passes\n5. \u2705 Refactor if needed\n6. \u2705 Commit with test + implementation together\n\n**No code without tests. No exceptions.**\n\n---\n\n## Timeline Estimate\n\n- **Phase 1**: \u2705 COMPLETE (4 hours actual)\n- **Phase 2**: 6-8 hours (reference workspaces + multi-DB)\n- **Phase 3**: 4-6 hours (maintenance ops)\n\n**Total**: 14-20 hours over 2-3 sessions\n\n---\n\n## Progress Summary\n\n**\u2705 Phase 1 COMPLETE**:\n- 23 tests passing (10 registry + 5 paths + 8 tool)\n- 88-100% coverage on new code\n- Full TDD methodology followed\n- Commit: 9af0947\n\n**\u23f3 Phase 2 NEXT**: Reference workspaces\n**\u23f3 Phase 3 PENDING**: Maintenance operations\n\n---\n\n## References\n\n- Julie's workspace architecture: `~/source/julie/docs/WORKSPACE_ARCHITECTURE.md`\n- Julie's ManageWorkspaceTool: `~/source/julie/src/tools/workspace/commands/mod.rs`\n- Julie 2.0 Plan: `~/source/julie/docs/JULIE_2_PLAN.md`\n",
  "git": {
    "branch": "main",
    "commit": "724ff83",
    "dirty": false,
    "files_changed": []
  },
  "id": "plan_implement-manageworkspace-tool-tdd",
  "status": "completed",
  "timestamp": 1763569356,
  "title": "Implement manage_workspace Tool (TDD)",
  "type": "plan"
}
