---
git:
  branch: main
  commit: d4f44b9
  dirty: true
  files_changed:
  - python/miller/server.py
  - python/miller/tools/trace_types.py
  - python/miller/toon_types.py
  - python/tests/test_fast_refs_toon.py
  - .memories/2025-11-20/143714_6c59.json
  - .memories/2025-11-20/144744_f6d3.json
  - .memories/2025-11-20/144942_879b.json
  - .memories/2025-11-20/145419_b676.json
  - .memories/2025-11-20/151411_93f8.json
  - .memories/2025-11-20/153944_a1ea.json
  - .memories/2025-11-20/171523_45c9.json
  - .memories/2025-11-21/
  - .memories/plans/plan_toon-format-migration-fastsearch-pilot.json
  - ULTRA_REVIEW_2025-11-20.md
  - measure_fast_refs_reduction.py
  - python/miller/hierarchical_toon.py
  - uv.lock
id: decision_6a7fe28f_77deb1
tags:
- toon-format
- fast-refs
- bug-fix
- architecture
- token-reduction
timestamp: 1763698946
type: decision
---

Fixed fast_refs TOON implementation: Reverted from broken hierarchical encoding to standard nested TOON, achieving 44% token reduction (902â†’505 chars). All 10 tests now pass. Key fixes: removed FastRefsFlattener, fixed case sensitivity bug, fixed false positive test. Hierarchical TOON works great for trace_call_path (63% reduction) but was wrong architecture for 2-level fast_refs structure.
