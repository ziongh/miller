name: Build Wheels

on:
  release:
    types: [ published ]
  workflow_dispatch:  # Allow manual triggering for testing

permissions:
  contents: read

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.platform.os }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # macOS builds (Universal2: Intel + Apple Silicon in one wheel)
          - os: macos-latest
            target: universal2-apple-darwin
            name: macOS (Universal)

          # Linux builds (x86_64 only - aarch64 has cross-compilation issues with tree-sitter grammars)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: Linux x86_64

          # NOTE: aarch64-unknown-linux-gnu removed - cross-compilation toolchain
          # has C99 compatibility issues with harper-tree-sitter-dart scanner.c
          # Julie doesn't build this target either for the same reason.

          # Windows builds (x64 only - ARM64 has same cross-compilation issues)
          - os: windows-latest
            target: x64
            name: Windows x64

          # NOTE: aarch64-pc-windows-msvc removed - Julie doesn't build this either

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Build wheels (maturin)
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform.name }}
          path: dist

  # Test the built wheels
  test_wheels:
    name: Test wheel on ${{ matrix.os }}
    needs: build_wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Install wheel
        run: |
          # Install our wheel from dist/, plus dependencies from PyPI
          # --prerelease=allow needed for toon-format>=0.9.0b1
          uv pip install --system --find-links dist --prerelease=allow miller-core

      - name: Test import
        run: python -c "from miller import miller_core; print('Miller core imported successfully')"

      - name: Run basic tests
        run: |
          uv pip install --system pytest
          pytest python/tests/ -v -k "test_core" -p no:cacheprovider --override-ini="addopts=" || echo "Core tests not found, skipping"

  # Build source distribution
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist

  # Publish to PyPI on release
  publish:
    name: Publish to PyPI
    needs: [build_wheels, build_sdist, test_wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: pypi
      url: https://pypi.org/p/miller
    permissions:
      id-token: write  # For PyPI trusted publishing

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
