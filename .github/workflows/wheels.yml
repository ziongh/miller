name: Build Wheels

on:
  release:
    types: [ published ]
  workflow_dispatch:  # Allow manual triggering for testing

permissions:
  contents: read

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.platform.os }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # macOS builds (Universal2: Intel + Apple Silicon in one wheel)
          - os: macos-latest
            target: universal2-apple-darwin
            name: macOS (Universal)

          # Linux builds (x86_64 only - aarch64 has cross-compilation issues with tree-sitter grammars)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: Linux x86_64

          # NOTE: aarch64-unknown-linux-gnu removed - cross-compilation toolchain
          # has C99 compatibility issues with harper-tree-sitter-dart scanner.c
          # Julie doesn't build this target either for the same reason.

          # Windows builds (x64 only - ARM64 has same cross-compilation issues)
          - os: windows-latest
            target: x64
            name: Windows x64

          # NOTE: aarch64-pc-windows-msvc removed - Julie doesn't build this either

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Build wheels (maturin)
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform.name }}
          path: dist

  # Test the built wheels
  test_wheels:
    name: Test wheel on ${{ matrix.os }}
    needs: build_wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Install wheel (no deps - just testing Rust extension)
        run: |
          # Install ONLY our wheel, skip heavy dependencies (torch, lancedb, etc.)
          # We only need to verify the Rust extension works, not the full ML stack
          # The Rust extension (miller_core) is self-contained - no Python deps needed
          uv pip install --system --no-deps --find-links dist miller-core

      - name: Debug - Show wheel contents
        run: |
          echo "=== Installed files ==="
          python -c "import miller; print(miller.__file__)"
          python -c "import os, miller; print(os.listdir(os.path.dirname(miller.__file__)))"

      - name: Verify Rust extension works
        run: |
          python -c "
          import sys

          # Direct import of Rust extension - don't use __init__.py which swallows errors
          # This will fail loudly if the extension can't load
          try:
              import miller.miller_core as miller_core
          except ImportError as e:
              print(f'IMPORT ERROR: {e}', file=sys.stderr)
              # Try to get more info
              import os, miller
              miller_dir = os.path.dirname(miller.__file__)
              print(f'miller directory: {miller_dir}', file=sys.stderr)
              print(f'Contents: {os.listdir(miller_dir)}', file=sys.stderr)
              raise

          print(f'miller_core version: {miller_core.__version__}')

          # Test symbol extraction (core functionality)
          result = miller_core.extract_file('def hello(): pass', 'python', 'test.py')
          assert len(result.symbols) > 0, f'Expected symbols, got {len(result.symbols)}'
          print(f'Extracted {len(result.symbols)} symbols from Python')

          # Test language detection
          lang = miller_core.detect_language('test.rs')
          assert lang == 'rust', f'Expected rust, got {lang}'
          print(f'Language detection: test.rs -> {lang}')

          # Test Rust code parsing
          rust_code = 'fn main() { println!(\"hello\"); }'
          rust_result = miller_core.extract_file(rust_code, 'rust', 'main.rs')
          assert len(rust_result.symbols) > 0
          print(f'Extracted {len(rust_result.symbols)} symbols from Rust')

          print('All smoke tests passed!')
          "

  # Build source distribution
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist

  # Publish to PyPI on release
  publish:
    name: Publish to PyPI
    needs: [build_wheels, build_sdist, test_wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: pypi
      url: https://pypi.org/p/miller
    permissions:
      id-token: write  # For PyPI trusted publishing

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
